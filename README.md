[Read this in English.](./README_en.md)

# 🚬 本工具集利用deepseek辅导开发完成，有些功能还待更多测试完善，有兴趣的朋友可自行下载安装插件，在使用过程中遇到的问题，请提交详细到issue，收到反馈后我会第一时间处理，谢谢！

## 安装插件
|方式一|
|------|
|ComfyUI管理器节点中搜索：ComfyUI-AlwaysOnline > install|

|方式二|
|------|
|git拉取到ComfyUI目录custom_nodes文件夹下 > 拉取后重启ComfyUI|
```
git clone https://github.com/alwaysOnlineYou/ComfyUI-AlwaysOnline.git
```

## GLM-4V推理节点共有两个：一个是图像反推，另一个是纯文本反推，纯文本反推支持系统角色和用户输入
|必须安装|
|------|
|首先，从源代码安装transformers：|
```
pip install git+https://github.com/huggingface/transformers.git
```

|可选安装|
|------|
|纯文本反推支持推理模式：sdpa、flash_attention_2，如需用flash_attention_2，请先安装flash_attention_2依赖：
```
pip install flash-attn --no-build-isolation
```

# 节点详细使用请见以下内容，还可安装后在工作流-浏览模板-ComfyUI-AlwaysOnline自定义模板下浏览示例工作流或在本仓库目录文件夹example_workflows下载后使用

## 🚬 动态水印生成器使用说明

### 核心功能
在图像/视频帧上添加可移动的文字水印，支持文生视频/图生视频工作流，水印位置根据帧索引自动更新。

### 自定义参数
| 参数 | 说明 |
|------|------|
| `text` | 水印文字内容 |
| `font_size` | 字体大小 (8-256px) |
| `font_color` | 文字颜色 (支持HEX/RGB格式) |
| `opacity` | 透明度 (0.0-1.0) |
| `speed` | 移动速度 (0.1-10倍速) |
| `trajectory` | 移动轨迹模式 |
| `font_path` | 自定义字体文件路径 |
| `custom_trajectory` | JSON格式的自定义路径 |
| `rotation` | 文字旋转角度 (-360°-360°) |
| `dynamic_size` | 启用动态字体大小 |
| `min_size`/`max_size` | 动态字体大小范围 |
| `stroke_width` | 文字描边宽度 |
| `stroke_color` | 描边颜色 |
| `shadow` | 启用阴影效果 |
| `shadow_color` | 阴影颜色 |
| `shadow_offset` | 阴影偏移量 |
| `blur_radius` | 模糊半径 |

### 轨迹模式
- `horizontal`: 水平移动
- `vertical`: 垂直移动
- `circular`: 圆形运动
- `diagonal`: 对角线移动
- `random`: 随机位置跳动
- `spiral`: 螺旋运动
- `wave`: 波浪运动
- `bounce`: 弹跳运动
- 自定义路径: 通过JSON坐标点定义

### 高级效果
- 自动旋转：圆形/螺旋轨迹自动跟随路径旋转
- 动态大小：文字大小随时间波动变化
- 描边效果：增强文字可读性
- 阴影效果：增加立体感
- 模糊效果：创建柔和的水印

### 自定义轨迹示例

#### 示例1：简单矩形路径
```json
[
  [0.1, 0.1],  // 左上角
  [0.9, 0.1],  // 右上角
  [0.9, 0.9],  // 右下角
  [0.1, 0.9],  // 左下角
  [0.1, 0.1]   // 返回起点
]
```
水印会沿矩形边界移动，适用于需要周期性循环的路径。

#### 示例2：贝塞尔曲线路径
```json
[
  [0.1, 0.5],
  [0.3, 0.1],
  [0.7, 0.9],
  [0.9, 0.5]
]
```
创建平滑的曲线运动，适合优雅的品牌水印展示。

#### 示例3：随机散点路径
```json
[
  [0.2, 0.3], [0.8, 0.4], [0.5, 0.7], 
  [0.3, 0.8], [0.7, 0.2], [0.4, 0.5]
]
```
创建看似随机但可控的运动，适合背景水印效果。

### 使用技巧
1. **路径点数量**：
   - 建议至少提供5个点以保证流畅运动
   - 复杂路径可使用20-50个点

2. **路径闭合**：
   - 如需循环路径，首尾点坐标应相同

3. **坐标范围**：
   - X坐标：0.0(左) → 1.0(右)
   - Y坐标：0.0(上) → 1.0(下)

4. **与速度配合**：
   - 较低速度(0.5-2.0)：适合复杂路径
   - 较高速度(3.0-5.0)：适合简单路径

5. **动态效果增强**：
   - 启用自动旋转使水印始终面向路径方向
   - 动态大小增加视觉趣味性

### 注意事项
1. 路径点数量应与总帧数匹配：
   - 100帧视频建议使用50-100个路径点
   - 使用 `len(custom_path) ≈ total_frames / 2` 公式

2. 超出屏幕处理：
   - 坐标可超出[0,1]范围创建进出效果
   - 例如：`[-0.1, 0.5] → [1.1, 0.5]` 实现左右穿屏

3. JSON格式验证：
   - 确保使用标准JSON格式
   - 可通过在线JSON验证工具检查

> 自定义轨迹功能提供了最大的灵活性，特别适合需要精确控制水印运动路径的品牌宣传、艺术创作等场景。通过精心设计的路径，可以创造出专业级的动态水印效果。

---

## GLM-4V 图像描述生成器

### 功能说明
专用于生成图像描述的ComfyUI节点，基于GLM-4V多模态模型实现

### 模型信息

#### 模型下载地址

| 模型                   | 下载地址                                                                                                                                               | 模型类型 |
|----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|------|
| GLM-4.1V-9B-Thinking | [🤗hf-mirror](https://hf-mirror.com/THUDM/GLM-4.1V-9B-Thinking)<br> [🤗Hugging Face](https://huggingface.co/THUDM/GLM-4.1V-9B-Thinking)<br> [🤖 ModelScope](https://modelscope.cn/models/ZhipuAI/GLM-4.1V-9B-Thinking) | 推理模型 |

### 硬件要求
- **显存需求**：H20显卡至少需要24GB显存
- **模型位置**：需放置在`models/LLM`目录下

### 安装准备
1. 下载GLM-4V模型至`models/LLM`目录
2. 确保目录结构：`ComfyUI/models/LLM/GLM-4.1V-9B-Thinking`

### 输入参数

#### 必需参数
| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| 图像 | IMAGE | - | - | 需要描述的输入图像 |
| 模型路径 | 下拉菜单 | GLM-4.1V-9B-Thinking | 自动扫描的模型列表 | 选择已安装的模型版本 |
| 用户输入 | 多行文本 | "简单描述这张图片内容" | - | 引导模型生成描述的提示词 |

#### 生成参数
| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| 温度 | FLOAT | 0.8 | 0.0-1.0 | 值越高输出越随机 |
| top_p | FLOAT | 0.6 | 0.0-1.0 | 核采样阈值 |
| top_k | INT | 2 | 1-200 | 候选token数量限制 |
| 最大新token数 | INT | 8192 | 512-16384 | 控制生成长度 |
| 重复惩罚 | FLOAT | 1.0 | 0.0-2.0 | 防止重复内容 |
| 卸载模型 | BOOL | True | - | 推理完成后释放显存 |

### 输出结果
| 输出名 | 类型 | 说明 |
|--------|------|------|
| 描述 | STRING | 生成的图像描述文本 |

### 使用流程
1. 连接输入图像
2. 选择模型版本（自动检测可用模型）
3. 修改提示词（可选）
4. 调整生成参数（推荐保持默认）
5. 执行生成获取描述

### 典型应用场景
- 自动化图像标注
- 视觉内容分析
- 多模态数据集处理

---

## GLM-4V 文本反推描述生成器

### 功能说明
使用GLM-4V模型生成图像描述或进行纯文本推理的ComfyUI节点

### 系统要求
- **显存需求**：H20显卡至少需要24GB显存
- **模型位置**：需放置在`models/LLM`目录下

### 安装说明
1. 将模型下载到`models/LLM`目录
2. 确保目录结构正确：`ComfyUI/models/LLM/GLM-4.1V-9B-Thinking`

### 输入参数

#### 必填参数
| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| 模型路径 | 下拉菜单 | GLM-4.1V-9B-Thinking | 自动扫描的模型列表 | 选择要使用的模型 |
| 系统角色 | 多行文本 | "You are a helpful assistant." | - | 设置AI的系统角色 |
| 用户输入 | 多行文本 | "简单描述这张图片内容" | - | 用户输入的提示词 |
| 温度 | 浮点数 | 0.8 | 0.0-1.0 | 控制生成随机性 |
| top_p | 浮点数 | 0.6 | 0.0-1.0 | 核采样参数 |
| top_k | 整数 | 2 | 1-200 | 限制最高概率token数量 |
| 最大新token数 | 整数 | 8192 | 512-16384 | 生成的最大token数量 |
| 重复惩罚 | 浮点数 | 1.0 | 0.0-2.0 | 控制重复惩罚系数 |
| 卸载模型 | 布尔值 | True | - | 是否在推理后卸载模型 |
| 推理模式 | 下拉菜单 | sdpa | MyOptions枚举值 | 选择推理模式 |

#### 可选参数
| 参数名 | 类型 | 说明 |
|--------|------|------|
| 图像 | IMAGE | 可选输入图像 |

### 输出
| 输出名 | 类型 | 说明 |
|--------|------|------|
| 描述 | STRING | 生成的描述文本 |

### 使用示例
1. 选择模型路径
2. 设置系统角色和用户输入
3. (可选)添加图像
4. 调整生成参数
5. 点击生成获取描述结果


---

## 文本处理工具集

### 功能概述
提供多种专业文本处理功能的ComfyUI节点集合，包含以下核心工具：

1. **多行文本合并器** - 支持多种合并方式和自定义分隔符
2. **文本替换工具** - 提供高级替换功能
3. **JSON键值提取器** - 支持复杂路径解析

---

### 1. MultilineTextMerger (多行文本合并)

#### 功能说明
智能合并多个文本输入，支持5个输入源和多种合并方式

#### 输入参数
| 参数名 | 类型 | 选项/默认值 | 说明 |
|--------|------|------------|------|
| 合并选项 | 下拉菜单 | 换行/双换行/空格/逗号/自定义 | 选择合并方式 |
| 忽略空文本 | 布尔值 | True | 是否跳过空文本 |
| text1-5 | 多行文本 | - | 1-5个文本输入源 |
| 自定义分隔符 | 单行文本 | - | 自定义合并分隔符 |

#### 特殊功能
- 自动修复不完整的Markdown代码块
- 智能清理多余换行符

#### 输出结果
| 输出名 | 类型 | 说明 |
|--------|------|------|
| 合并后的文本 | STRING | 格式完整的合并文本 |

---

### 2. TextReplacer (文本替换)

#### 功能说明
提供高级文本替换功能，支持正则表达式和大小写敏感选项

#### 输入参数
| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| text | 多行文本 | - | 原始文本 |
| find | 单行文本 | - | 查找内容 |
| replace | 单行文本 | - | 替换内容 |
| replace_all | 布尔值 | True | 全局替换/单次替换 |
| case_sensitive | 布尔值 | False | 是否区分大小写 |

#### 输出结果
| 输出名 | 类型 | 说明 |
|--------|------|------|
| 修改后的文本 | STRING | 替换后的文本 |

---

### 3. JsonKeyExtractor (JSON键值提取)

#### 功能说明
支持复杂JSON路径解析，包括：
- 嵌套对象 (user.address.city)
- 数组索引 (items[0].name)
- 混合路径 (users[1].scores[0])

#### 输入参数
| 参数名 | 类型 | 示例 | 说明 |
|--------|------|------|------|
| json文本 | 多行文本 | {"user": {"name": "John"}} | 原始JSON文本 |
| 键 | 单行文本 | user.name | 提取路径 |

#### 路径示例
- `data.users[0].name`
- `items[1].price`
- `status` (直接键)
- 空路径返回完整JSON

#### 输出结果
| 输出名 | 类型 | 说明 |
|--------|------|------|
| 值 | STRING | 提取的结果或空字符串 |

---

### 安装与使用
1. 将节点文件放入ComfyUI自定义节点目录
2. 在"🚬香烟的工具箱✅"分类下查找
3. 连接输入输出即可使用
